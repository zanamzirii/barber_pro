rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() {
      return request.auth != null;
    }

    function userData(uid) {
      return get(/databases/$(database)/documents/users/$(uid)).data;
    }

    function userRole() {
      return isSignedIn()
        ? (
          userData(request.auth.uid).activeRole != null
            ? userData(request.auth.uid).activeRole
            : userData(request.auth.uid).role
        )
        : null;
    }

    function isSuperAdmin() {
      return isSignedIn() && userRole() == 'superadmin';
    }

    function isOwner() {
      return isSignedIn() && userRole() == 'owner';
    }

    function ownerShopId() {
      return isSignedIn() ? userData(request.auth.uid).shopId : null;
    }

    function isBarberForShop(shopId) {
      return isSignedIn() &&
        userRole() == 'barber' &&
        ownerShopId() == shopId;
    }

    function managesShop(shopId) {
      return isSignedIn() && (
        isSuperAdmin() ||
        request.auth.uid == shopId ||
        (userRole() == 'owner' && ownerShopId() == shopId)
      );
    }

    function userBelongsToOwnerShop(data) {
      return data.shopId == ownerShopId() || data.branchId == ownerShopId();
    }

    function ownerCanReadUser() {
      return isOwner() && resource.data != null && userBelongsToOwnerShop(resource.data);
    }

    function ownerCanManageBarber() {
      return isOwner()
        && resource.data != null
        && userBelongsToOwnerShop(resource.data)
        && request.auth.uid != resource.id
        && request.resource.data.diff(resource.data).changedKeys().hasOnly([
          'isActive',
          'updatedAt',
          'branchId',
          'shopId',
          'roles',
          'activeRole',
          'role'
        ]);
    }

    function inviteShopId(data) {
      return data.branchId != null ? data.branchId : data.shopId;
    }

    match /users/{userId} {
      allow create: if request.auth != null
        && request.auth.uid == userId
        && request.resource.data.uid == request.auth.uid;
      allow read: if isSignedIn()
        && (request.auth.uid == userId || isSuperAdmin() || ownerCanReadUser());
      allow update: if isSignedIn()
        && (request.auth.uid == userId || isSuperAdmin() || ownerCanManageBarber());
      allow delete: if isSignedIn()
        && (request.auth.uid == userId || isSuperAdmin());
    }

    match /shops/{shopId} {
      allow read: if isSignedIn();
      allow create, update, delete: if managesShop(shopId);

      match /barbers/{barberId} {
        allow read: if isSignedIn();
        allow create: if managesShop(shopId) || (
          isBarberForShop(shopId) &&
          request.resource.data.barberId == request.auth.uid &&
          request.resource.data.barberUserId == request.auth.uid
        );
        allow update: if managesShop(shopId) || (
          isBarberForShop(shopId) &&
          resource.data.barberId == request.auth.uid &&
          request.resource.data.barberId == request.auth.uid &&
          request.resource.data.barberUserId == request.auth.uid
        );
        allow delete: if managesShop(shopId);
      }

      match /services/{serviceId} {
        allow read: if isSignedIn();
        allow create, update, delete: if managesShop(shopId);
      }
    }

    match /barber_invites/{inviteId} {
      allow create: if isSignedIn() && (
        isSuperAdmin() ||
        request.resource.data.ownerId == request.auth.uid ||
        managesShop(request.resource.data.shopId)
      );

      // Public read is enabled for invite-code lookup during onboarding.
      allow read: if true;

      allow update: if isSignedIn() && (
        isSuperAdmin() ||
        resource.data.ownerId == request.auth.uid ||
        managesShop(resource.data.shopId) ||
        request.auth.token.email == resource.data.email
      );

      allow delete: if isSignedIn() &&
        (
          isSuperAdmin() ||
          resource.data.ownerId == request.auth.uid ||
          managesShop(resource.data.shopId)
        );
    }

    match /invites/{inviteId} {
      allow create: if isSignedIn() && (
        isSuperAdmin() ||
        request.resource.data.ownerId == request.auth.uid ||
        managesShop(inviteShopId(request.resource.data))
      );

      // Public read allows invite-code verification during barber onboarding.
      allow read: if true;

      allow update: if isSignedIn() && (
        isSuperAdmin() ||
        resource.data.ownerId == request.auth.uid ||
        managesShop(inviteShopId(resource.data)) ||
        request.auth.token.email == resource.data.email ||
        request.resource.data.claimedBy == request.auth.uid
      );

      allow delete: if isSignedIn() && (
        isSuperAdmin() ||
        resource.data.ownerId == request.auth.uid ||
        managesShop(inviteShopId(resource.data))
      );
    }

    match /appointments/{appointmentId} {
      allow read: if isSignedIn() && (
        isSuperAdmin() ||
        resource.data.customerId == request.auth.uid ||
        resource.data.barberId == request.auth.uid ||
        managesShop(resource.data.shopId)
      );

      allow create: if isSignedIn() && (
        isSuperAdmin() ||
        request.resource.data.customerId == request.auth.uid ||
        managesShop(request.resource.data.shopId)
      );

      allow update, delete: if isSignedIn() && (
        isSuperAdmin() ||
        managesShop(resource.data.shopId) ||
        resource.data.barberId == request.auth.uid ||
        (
          resource.data.customerId == request.auth.uid &&
          resource.data.status == 'pending'
        )
      );
    }

    // Deny everything else by default.
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
